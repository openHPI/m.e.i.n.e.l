<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="plotly-import.html">
<link rel="import" href="all-imports.html">

<!--
`ajax-wrapper`
This component handles a given url by asynchronously fetching data from it and
creating and passing the data to a charting component, specified in a parameter.
@demo demo/ajax_wrapper_demo.html
-->
<dom-module id="ajax-wrapper">
    <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-ajax
        id="ajaxCaller"
        url="[[dataurl]]"
        handle-as="json"
        on-response="handleResponse"
        debounce-duration="300">
    </iron-ajax>
    <content id="chartingElement"></content>
  </template>
    <script>
        window.addEventListener("WebComponentsReady", function(){
        Polymer({
            is: 'ajax-wrapper',

            properties: {
                /** URL of data to be fetched */
                dataurl: {
                    type: String,
                },
                /** Name of charting component to be created (optional).*/
                diagramType: {
                    type: String,
                    value: '',
                },
                /** Width of the outer div */
                width: {
                    type: Number,
                },
                /** Height of the out div */
                height: {
                    type: Number,
                },
                /** Primary color of the included chart */
                primarycolor: {
                    type: String,
                    value: '#930517',
                },
                /** Accent color of the included chart */
                accentcolor: {
                    type: String,
                    value: '#F5E8BB',
                },
            },
            attached: function() {
                this.$.ajaxCaller.generateRequest();
            },
            /**
             * Handle the ajax response and pass data and parameters down to
             * contained elements. Or create a new charting element if a
             * diagramType was defined.
             *
             * @param {Object} data The data returned from the dataurl
             */
            handleResponse: function(data) {
                var dataArray = this._readDataFromResponse(data.detail.response);
                if (this.diagramType) {
                    var newChartingElement = document.createElement(this.diagramType);
                    Polymer.dom(this).appendChild(newChartingElement);
                }
                for (let chartingElement of Polymer.dom(this).children) {
                    chartingElement.primarycolor = this.primarycolor;
                    chartingElement.accentcolor = this.accentcolor;
                    chartingElement.width = this.width;
                    chartingElement.height = this.height;
                    chartingElement.data = JSON.parse(JSON.stringify(dataArray));   //we need a deep copy here. See benchmark: http://jsben.ch/#/bWfk9
                }
            },

            /**
             * Parse the received data to a plotly readable Object
             *
             * @param {Object} data data to be parsed
             */
            _readDataFromResponse: function(data) {
                var x = [];
                var y = [];
                for (entry in data) {
                    x.push(entry);
                    y.push(data[entry]);
                }
                var diagramData = {
                    "x": x
                };
                diagramData["y"] = y;
                var plotlyData = [];
                plotlyData.push(diagramData);
                return plotlyData;
            }
        });
     });
    </script>
</dom-module>
