<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="plotly-import.html">


<!--
`barchart-basic`
<br />This is a basic component for plotly barcharts.
<br />For further information and deeper understanding visit the <a href="https://plot.ly/javascript/bar-charts/" target="_blank">Plotly bar chart documentation</a>.

@demo demo/barchart_basic_demo.html
-->
<dom-module id="barchart-basic">
    <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <div id="diagram"></div>
  </template>

    <script>
        window.addEventListener("WebComponentsReady", function() {
            Polymer({
                is: 'barchart-basic',
                properties: {
                    /** Datavalues to be plotted */
                    data: {
                        type: Array,
                        notify: true,
                    },
                    /** Width of the outer div */
                    width: {
                        type: Number,
                        reflectToAttribute: true,
                    },
                    /** Height of the outer div */
                    height: {
                        type: Number,
                        reflectToAttribute: true,
                    },
                    /** Primary color of chart */
                    primarycolor: {
                        type: String,
                        value: 'rgba(0,0,0,1)',
                        reflectToAttribute: true,
                    },
                    /** Accent color of chart */
                    accentcolor: {
                        type: String,
                        value: 'rgba(0,0,0,1)',
                        reflectToAttribute: true,
                    },
                    /** Scroll and zoom activation */
                    scrollzoom: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true,
                    },
                    /** Scroll range provided in % 0 to 100 */
                    scrollrange: {
                        type: Number,
                        value: 100,
                        reflectToAttribute: true,
                    },
                    /** Enables stacked bar if multiple xy objects are provided */
                    stackedbar: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true,
                    },
                },
                /** This is called by Polymer after the component instance is attached to the document. */
                attached: function() {
                    this.listen(this, 'data-changed', '_dataChanged');
                    this._plotDiagram();
                },
                /**
                 * Eventhandler, called when value of the data attribute has changed. Will cause the diagram to redraw.
                 *
                 */
                _dataChanged: function() {
                    this._plotDiagram();
                },
                /**
                 * Plots the barchart diagram.
                 *
                 */
                _plotDiagram: function() {
                    if(this.data == null) {
                        return;
                    }
                    for(var i = 0; i < this.data.length; i++) {
                      this.data[i]["type"] = "bar";
                    };
                    this.data[0]["marker"] = {
                        color: this.primarycolor
                    };

                    var d3 = Plotly.d3;

                    /** Reset plot area in case we're redrawing*/
                    var gd3 = d3.select(this.$.diagram).selectAll("*").remove();

                    var WIDTH_IN_PERCENT_OF_PARENT = 100,
                        HEIGHT_IN_PERCENT_OF_PARENT = 100;

                    /** Defines the width and height of the outer div */
                    if (this.width && this.height) {
                        var diagram = d3.select(this.$.diagram);

                        diagram.style('width', this.width + "px");
                        diagram.style('height', this.height + "px");
                    }

                    /** Create new div with specific attributes under outer div */
                    var gd3 = d3.select(this.$.diagram)
                        .append('div')
                        .style({
                            width: WIDTH_IN_PERCENT_OF_PARENT + '%',
                            'margin-left': (100 - WIDTH_IN_PERCENT_OF_PARENT) / 2 + '%',

                            height: HEIGHT_IN_PERCENT_OF_PARENT + '%',
                            'margin-top': (100 - HEIGHT_IN_PERCENT_OF_PARENT) / 2 + '%'
                        });

                    var gd = gd3.node();

                    var layout = {
                        xaxis: {
                            tickmode: "auto",
                            tickfont: {
                                size: 14,
                                color: this.accentcolor,
                            },
                        },
                        yaxis: {
                            tickfont: {
                                size: 14,
                                color: this.accentcolor,
                            },
                        },
                    };

                    (this.stackedbar) ? layout.barmode = 'stack' : '';

                    /** Create different layouts depending on scrollzoom being active or not */
                    if (this.scrollzoom) {
                      var maxX = this.data[0]["x"][this.data[0]["x"].length-1];
                      var minX = this.data[0]["x"][Math.round(this.data[0]["x"].length*(1-this.scrollrange/100))];
                      layout.xaxis.rangeslider = {};
                      layout.xaxis.range = [minX, maxX];

                      Plotly.newPlot(gd, this.data, layout, {scrollZoom: true});
                    } else {
                      Plotly.newPlot(gd, this.data, layout);
                    }

                    window.addEventListener('resize', function() {
                        Plotly.Plots.resize(gd);
                    });
                },
            });
        });
    </script>
</dom-module>
