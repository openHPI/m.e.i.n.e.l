<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="d3-import.html">


<!--
`activitychart-basic`
This component shows an activity history, similar to the colored github chart

@demo demo/activitychart_basic_demo.html
-->
<dom-module id="activitychart-basic">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-ajax
        id="ajaxCaller"
        url="[[dataurl]]"
        handle-as="json"
        on-response="handleResponse"
        debounce-duration="300">
    </iron-ajax>
    <div style="display:none;">{{dataset}}</div>
    <div id="diagram"></div>
  </template>

  <script>
    Polymer({
      is: 'activitychart-basic',

      properties: {
        /** URL of data to be plotted */
        dataurl: {
          type: String,
          value: '',
        },
        /** y values in JSON format (data to be displayed) */
        dataset: {
          type: Array,
        },
        /** x values in JSON format (labels for data) */
        labels: {
          type: Array,
        },
        /** Primary color of chart */
        primarycolor: {
          type: String,
          value: 'rgba(0,0,0,1)',
        },
        /** Accent color of chart */
        accentcolor: {
          type: String,
          value: 'rgba(0,0,0,1)',
        },
        /** Number of colored dots per row (opt, default 8) */
        squaresPerRow: {
          type: Number,
          value: 8,
        },
        /** Width of square (opt, default: 15) */
        squareWidth: {
          type: Number,
          value: 15,
        },
        /** Spacing of squares (opt, default: 20) */
        squareSpacing: {
          type: Number,
          value: 20,
        },
      },

      attached: function() {
        if(this.dataurl != "") {
          this.$.ajaxCaller.generateRequest();
        }
        else {
          this._plotDiagram();
        }
      },
      /**
      * Transforms the transmitted data into a plot
      *
      * @param {Object} data The data to be plotted
      */
      handleResponse: function (data) {
        var goodData = this._normalizeJSON(data.detail.response);
        this.dataset = goodData[0]["y"];
        this.labels = goodData[0]["x"];
        this._plotDiagram();
      },

      _plotDiagram: function () {
        console.log("Plotting...");
        console.log(this.dataset);
        console.log(this.labels);
        var diagramDiv = this.$.diagram;

        var dataset = this.dataset;
        var datasetMin = Math.min(...dataset);
        var datasetMax = Math.max(...dataset);

        var svgWidth = this.squaresPerRow * this.squareSpacing,
        svgHeight = Math.ceil(dataset.length / this.squaresPerRow) * this.squareSpacing;

        //so far, the appropriate color is calculated based on the value of the datum, there is no set of fixed colors
        var colorScale = d3.scaleLinear()
          .domain([datasetMin, datasetMax])
          .range(['#F5E8BB', '#930517']);

        var svg = d3.select('#diagram').append('svg')
          .attr('width', svgWidth)
          .attr('height', svgHeight);


        var squares = svg.selectAll('rect')
          .data(dataset)
          .enter().append('rect')
          .attr('width', this.squareWidth)
          .attr('height', this.squareWidth)
          .attr('x', this._spaceSquareHor)
          .attr('y', this._spaceSquareVert)
          .attr('fill', colorScale)
          .on('mouseover', this._showLabel)
          .on('mouseout', this._hideLabel);
      },

      _showLabel: function (d, i) {
        //using a group element 'label' with an appended text element and a rect element as background to display a label

        var polyElement = Polymer.dom(this).parentNode.parentNode.parentNode;
        var label = d3.select('svg').append('g')
          .attr('id', 'label-' + i);

        //append rect element first so that following text element is displayed above rect
        label.append('rect');
        var labelText = label.append('text')
					.text(d + ' at ' + polyElement.labels[i])
					.style('font-size', '0.8em')
					.attr('fill', 'black');
        //this split is necessary because the position is set relative to the size of the text element
        labelText
          .attr('x', polyElement._spaceLabelHor(d, i, labelText.node().getBBox().width))
          .attr('y', polyElement._spaceLabelVert(d, i));

        //finish rect configuration that was appended previously
        label.select('rect')
          .attr('x', labelText.attr('x') - 3)
  				.attr('y', labelText.attr('y') - 11)
  				.attr('fill', 'white')
  				.attr('width', labelText.node().getBBox().width + 3)
      		.attr('height', labelText.node().getBBox().height);
			},

      _hideLabel: function (d, i) {
        d3.select('#label-' + i).remove();
      },

      _spaceLabelHor: function(d, i, labelWidth) {
        var x = this._spaceSquareHor(d, i);
        //calculate the maximum x position possible so that the label won't be cut off on the edge of the SVG
        var maxPosition = ((this.squareSpacing * (this.squaresPerRow - 1)) + this.squareWidth) - labelWidth;

        if(x > maxPosition) { // label would normally be "shown" outside the SVG space
          x = maxPosition + 1;
        }
        return x;
      },

      _spaceLabelVert: function(d, i) {
        var y = this._spaceSquareVert(d, i) - 3;
        if(y < 0) { // label would normally be "shown" outside the SVG space
          y = this.squareSpacing * 1.5;
        }
        return y;
      },

      _spaceSquareHor: function (d, i) {
        var polyElement = this;
        if (Polymer.dom(this).node.nodeName != "ACTIVITYCHART-BASIC") {
          var polyElement = Polymer.dom(this).parentNode.parentNode.parentNode;
        }
        return polyElement.squareSpacing * (i % polyElement.squaresPerRow);
			},

      _spaceSquareVert: function (d, i) {
        var polyElement = this;
        if (Polymer.dom(this).node.nodeName != "ACTIVITYCHART-BASIC") {
          var polyElement = Polymer.dom(this).parentNode.parentNode.parentNode;
        }
				return polyElement.squareSpacing * (Math.floor(i / polyElement.squaresPerRow));
			},
      /**
      * Normalizes the data supplied by the API to work with Plotly
      *
      * @param {Object} data The data (as JSON) to be normalized
      * @return {Array} The normalized data
      */
      _normalizeJSON: function (data) {
        var x = [];
        var y = [];
        for (entry in data) {
          //compute date string
          //x.push(entry);
          x.push((new Date(entry*1000)).toLocaleString());
          y.push(data[entry]);
        }
        var diagramData = {"x":x};
        diagramData["y"] = y;
        diagramData["type"] = "bar";
        diagramData["marker"] = {color:this.primarycolor};
        var plotlyData = [];
        plotlyData.push(diagramData);
        return plotlyData;
      }
    });
  </script>
</dom-module>
