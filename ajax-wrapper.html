<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="plotly-import.html">
<link rel="import" href="all-imports.html">



<!--
`ajax-wrapper`
This is a component handling ajax calls to fetch data and passing it on to another component to display it.

@demo demo/ajax_wrapper_demo.html
-->
<dom-module id="ajax-wrapper">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-ajax
        id="ajaxCaller"
        url="[[dataurl]]"
        handle-as="json"
        on-response="handleResponse"
        debounce-duration="300">
    </iron-ajax>
    <div id="diagramComponent"></div>
  </template>

  <script>
    Polymer({
      is: 'ajax-wrapper',

      properties: {
        /** URL of data to be plotted */
        dataurl: {
          type: String,
        },
        /** Name of charting component to be used */
        diagramType: {
          type: String,
        },
        /** Width of the outer div */
        width: {
          type: Number,
        },
        /** Height of the out div */
        height: {
          type: Number,
        },
        /** Primary color of the included chart */
        primarycolor: {
          type: String,
          value: 'rgba(0,0,0,1)',
        },
        /** Accent color of the included chart */
        accentcolor: {
          type: String,
          value: 'rgba(0,0,0,1)',
        },
      },
      attached: function() {
        this.$.ajaxCaller.generateRequest();
      },
      /**
      * Parse the data and pass it on to the included charting component.
      *
      * @param {Object} data The data returned from the dataurl
      */
      handleResponse: function (data) {
        var dataArray = this._readDataFromResponse(data.detail.response);
        var diagramElement = document.createElement(this.diagramType);
        // console.log(dataArray);
        diagramElement.data = dataArray;
        diagramElement.primarycolor = this.primarycolor;
        diagramElement.accentcolor = this.accentcolor;
        diagramElement.width = this.width;
        diagramElement.height = this.height;
        this.$.diagramComponent.appendChild(diagramElement);
      },

      _readDataFromResponse: function (data) {
        var x = [];
        var y = [];
        for (entry in data) {
          x.push(entry);
          y.push(data[entry]);
        }
        var diagramData = {"x":x};
        diagramData["y"] = y;
        var plotlyData = [];
        plotlyData.push(diagramData);
        return plotlyData;
      }
    });
  </script>
</dom-module>
